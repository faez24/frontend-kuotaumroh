<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daftar Agent - Kuotaumroh.id</title>

  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="public/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="public/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="public/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="public/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="public/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="public/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="public/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="public/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="public/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="public/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="public/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="public/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="public/favicon/favicon-16x16.png">
  <link rel="manifest" href="public/favicon/manifest.json">
  <meta name="msapplication-TileColor" content="#10b981">
  <meta name="msapplication-TileImage" content="public/favicon/ms-icon-144x144.png">
  <meta name="theme-color" content="#10b981">

  <!-- Google Fonts - Figtree -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Shared CSS -->
  <link rel="stylesheet" href="shared/styles.css">

  <!-- Leaflet.js CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

  <!-- Leaflet.js JavaScript -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            border: "hsl(var(--border))",
            input: "hsl(var(--input))",
            ring: "hsl(var(--ring))",
            background: "hsl(var(--background))",
            foreground: "hsl(var(--foreground))",
            primary: {
              DEFAULT: "hsl(var(--primary))",
              foreground: "hsl(var(--primary-foreground))",
            },
            secondary: {
              DEFAULT: "hsl(var(--secondary))",
              foreground: "hsl(var(--secondary-foreground))",
            },
            destructive: {
              DEFAULT: "hsl(var(--destructive))",
              foreground: "hsl(var(--destructive-foreground))",
            },
            muted: {
              DEFAULT: "hsl(var(--muted))",
              foreground: "hsl(var(--muted-foreground))",
            },
            accent: {
              DEFAULT: "hsl(var(--accent))",
              foreground: "hsl(var(--accent-foreground))",
            },
            card: {
              DEFAULT: "hsl(var(--card))",
              foreground: "hsl(var(--card-foreground))",
            },
          },
          fontFamily: {
            sans: ['Figtree', 'ui-sans-serif', 'system-ui', '-apple-system', 'sans-serif'],
          },
          borderRadius: {
            lg: "var(--radius)",
            md: "calc(var(--radius) - 2px)",
            sm: "calc(var(--radius) - 4px)",
          },
        },
      },
    }
  </script>
</head>

<body class="min-h-screen bg-background">
  <div x-data="signupApp()">
    
    <!-- Header -->
    <header class="sticky top-0 z-50 w-full border-b bg-background/95 backdrop-blur">
      <div class="container mx-auto flex h-16 items-center justify-between px-4">
        <div class="flex items-center gap-2">
          <img src="public/images/kabah.png" alt="Kuotaumroh.id" class="h-9 w-9 object-contain">
          <span class="text-xl font-semibold">Kuotaumroh.id</span>
        </div>
        <a 
          href="login.html" 
          class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground h-9 px-4 text-sm font-medium hover:bg-primary/90 transition-colors"
        >
          Login
        </a>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto py-8 px-4 max-w-3xl animate-fade-in">
      
      <!-- Back Button -->
      <div class="mb-6">
        <a 
          href="index.html" 
          class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors"
        >
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back
        </a>
      </div>

      <!-- Page Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold tracking-tight mb-2">Daftar Agent</h1>
        <p class="text-muted-foreground">Bergabunglah dengan kami sebagai agent Kuotaumroh.id</p>
      </div>

      <!-- Registration Form -->
      <div class="rounded-lg border bg-white shadow-sm">
        <div class="p-6">
          <form @submit.prevent="handleSubmit" class="space-y-6">
            
            <!-- Contact Information Section -->
            <div class="space-y-4">
              <h2 class="text-lg font-semibold border-b pb-2">Informasi Kontak</h2>
              
              <!-- Email -->
              <div class="space-y-2">
                <label for="email" class="text-sm font-medium">Email</label>
                <input
                  id="email"
                  type="email"
                  x-model="formData.email"
                  placeholder="Email"
                  disabled
                  class="flex h-10 w-full rounded-md border border-input bg-muted px-3 py-2 text-sm opacity-60 cursor-not-allowed"
                >
                <p class="text-xs text-muted-foreground">Email dari akun Google Anda</p>
              </div>

              <!-- Phone Number -->
              <div class="space-y-2">
                <label for="phone" class="text-sm font-medium">No. HP (+62)</label>
                <input
                  id="phone"
                  type="tel"
                  x-model="formData.phone"
                  placeholder="6281xxx"
                  class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                >
                <p class="text-xs text-muted-foreground">Format: 6281xxxxxxxxx (tanpa +62)</p>
              </div>

              <!-- Full Name -->
              <div class="space-y-2">
                <label for="full_name" class="text-sm font-medium">Nama Lengkap</label>
                <input
                  id="full_name"
                  type="text"
                  x-model="formData.full_name"
                  class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                >
              </div>
            </div>

            <!-- Agent Information Section -->
            <div class="space-y-4">
              <h2 class="text-lg font-semibold border-b pb-2">Informasi Agent</h2>
              
              <!-- User Type -->
              <div class="space-y-2">
                <label for="user_type" class="text-sm font-medium">Pilih Jenis Agent</label>
                <select
                  id="user_type"
                  x-model="formData.user_type"
                  class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                >
                  <option value="TRAVEL">TOUR & TRAVEL</option>
                </select>
              </div>

              <!-- Travel Name -->
              <div class="space-y-2">
                <label for="travel_name" class="text-sm font-medium">Nama Travel</label>
                <input
                  id="travel_name"
                  type="text"
                  x-model="formData.travel_name"
                  class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                >
              </div>

              <!-- Travel Type -->
              <div class="space-y-2">
                <label for="travel_type" class="text-sm font-medium">Jenis Travel</label>
                <select
                  id="travel_type"
                  x-model="formData.travel_type"
                  class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                >
                  <option value="">Pilih jenis travel</option>
                  <option value="UMROH">UMROH</option>
                  <option value="LEISURE">LEISURE</option>
                  <option value="UMROH LEISURE">UMROH & LEISURE</option>
                </select>
              </div>

              <!-- Travel Member -->
              <div class="space-y-2">
                <label for="travel_member" class="text-sm font-medium">Total Traveller per Bulan</label>
                <input
                  id="travel_member"
                  type="number"
                  x-model="formData.travel_member"
                  min="0"
                  class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                >
              </div>
            </div>

            <!-- Address Information Section -->
            <div class="space-y-4">
              <h2 class="text-lg font-semibold border-b pb-2">Informasi Alamat</h2>
              
              <!-- City (Searchable) -->
              <div class="space-y-2" x-data="{ cityDropdownOpen: false, citySearch: '' }" x-init="$watch('cityDropdownOpen', value => { if (value) $nextTick(() => $refs.citySearchInput.focus()) })">
                <label for="city" class="text-sm font-medium">Pilih Kota/Kab</label>
                
                <!-- Custom Searchable Dropdown -->
                <div class="relative" @click.away="cityDropdownOpen = false">
                  <!-- Trigger Button -->
                  <button
                    type="button"
                    @click="cityDropdownOpen = !cityDropdownOpen"
                    class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                  >
                    <span :class="!formData.city && 'text-muted-foreground'" x-text="formData.city || 'Pilih kota/kabupaten'"></span>
                    <svg class="h-4 w-4 transition-transform" :class="cityDropdownOpen && 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </button>

                  <!-- Dropdown Panel -->
                  <div
                    x-show="cityDropdownOpen"
                    x-transition
                    class="absolute z-50 mt-1 w-full rounded-md border border-input bg-white shadow-lg"
                  >
                    <!-- Search Input -->
                    <div class="p-2 border-b">
                      <input
                        type="text"
                        x-ref="citySearchInput"
                        x-model="citySearch"
                        @click.stop
                        placeholder="Cari kota/kabupaten..."
                        class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                      >
                    </div>

                    <!-- Options List -->
                    <div class="max-h-60 overflow-y-auto p-1">
                      <template x-for="city in filteredCities(citySearch)" :key="city">
                        <button
                          type="button"
                          @click="formData.city = city; handleCityChange(); cityDropdownOpen = false; citySearch = ''"
                          :class="formData.city === city && 'bg-primary/10 text-primary'"
                          class="w-full text-left px-3 py-2 text-sm rounded hover:bg-accent transition-colors"
                          x-text="city"
                        ></button>
                      </template>
                      
                      <!-- No Results -->
                      <div x-show="filteredCities(citySearch).length === 0" class="px-3 py-6 text-center text-sm text-muted-foreground">
                        Tidak ada hasil ditemukan
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Subdistrict (Searchable) -->
              <div class="space-y-2" x-data="{ subdistrictDropdownOpen: false, subdistrictSearch: '' }" x-init="$watch('subdistrictDropdownOpen', value => { if (value) $nextTick(() => $refs.subdistrictSearchInput.focus()) })">
                <label for="subdistrict" class="text-sm font-medium">Pilih Kecamatan</label>
                
                <!-- Custom Searchable Dropdown -->
                <div class="relative" @click.away="subdistrictDropdownOpen = false">
                  <!-- Trigger Button -->
                  <button
                    type="button"
                    @click="subdistrictDropdownOpen = !subdistrictDropdownOpen"
                    :disabled="!formData.city"
                    class="flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <span :class="!formData.subdistrict && 'text-muted-foreground'" x-text="formData.subdistrict || 'Pilih kecamatan'"></span>
                    <svg class="h-4 w-4 transition-transform" :class="subdistrictDropdownOpen && 'rotate-180'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                  </button>

                  <!-- Dropdown Panel -->
                  <div
                    x-show="subdistrictDropdownOpen"
                    x-transition
                    class="absolute z-50 mt-1 w-full rounded-md border border-input bg-white shadow-lg"
                  >
                    <!-- Search Input -->
                    <div class="p-2 border-b">
                      <input
                        type="text"
                        x-ref="subdistrictSearchInput"
                        x-model="subdistrictSearch"
                        @click.stop
                        placeholder="Cari kecamatan..."
                        class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                      >
                    </div>

                    <!-- Options List -->
                    <div class="max-h-60 overflow-y-auto p-1">
                      <template x-for="subdistrict in filteredSubdistricts(subdistrictSearch)" :key="subdistrict">
                        <button
                          type="button"
                          @click="formData.subdistrict = subdistrict; subdistrictDropdownOpen = false; subdistrictSearch = ''"
                          :class="formData.subdistrict === subdistrict && 'bg-primary/10 text-primary'"
                          class="w-full text-left px-3 py-2 text-sm rounded hover:bg-accent transition-colors"
                          x-text="subdistrict"
                        ></button>
                      </template>
                      
                      <!-- No Results -->
                      <div x-show="filteredSubdistricts(subdistrictSearch).length === 0" class="px-3 py-6 text-center text-sm text-muted-foreground">
                        Tidak ada hasil ditemukan
                      </div>
                    </div>
                  </div>
                </div>
                <p class="text-xs text-muted-foreground" x-show="!formData.city">Pilih kota terlebih dahulu</p>
              </div>

              <!-- Full Address -->
              <div class="space-y-2">
                <label for="address" class="text-sm font-medium">Alamat Lengkap</label>
                <textarea
                  id="address"
                  x-model="formData.address"
                  rows="3"
                  class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                ></textarea>
              </div>

              <!-- RT & RW -->
              <div class="grid grid-cols-2 gap-4">
                <div class="space-y-2">
                  <label for="rt" class="text-sm font-medium">RT</label>
                  <input
                    id="rt"
                    type="number"
                    x-model="formData.rt"
                    min="0"
                    class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                  >
                </div>
                <div class="space-y-2">
                  <label for="rw" class="text-sm font-medium">RW</label>
                  <input
                    id="rw"
                    type="number"
                    x-model="formData.rw"
                    min="0"
                    class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-ring"
                  >
                </div>
              </div>

              <!-- Map Section -->
              <div class="space-y-2" x-show="formData.city">
                <label class="text-sm font-medium">Tandai Lokasi di Peta</label>
                <p class="text-xs text-muted-foreground">Klik pada peta untuk menandai lokasi Anda</p>
                
                <!-- Map Container -->
                <div 
                  id="map" 
                  class="w-full h-96 rounded-md border border-input overflow-hidden"
                  x-init="$nextTick(() => { if (formData.city && !mapInitialized) initializeMap(); })"
                ></div>
                
                <!-- Coordinates Display -->
                <div x-show="formData.latitude && formData.longitude" class="p-3 rounded-md bg-muted/30 border">
                  <div class="flex items-center gap-2 text-sm">
                    <svg class="h-5 w-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <div>
                      <span class="font-medium">Koordinat:</span>
                      <span class="text-muted-foreground ml-2">
                        Lat: <span x-text="formData.latitude?.toFixed(6)"></span>,
                        Long: <span x-text="formData.longitude?.toFixed(6)"></span>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Logo Upload Section -->
            <div class="space-y-4">
              <h2 class="text-lg font-semibold border-b pb-2">Logo Travel (Opsional)</h2>
              
              <div class="space-y-2">
                <label class="text-sm font-medium">Upload Logo</label>
                <div class="flex items-center gap-4">
                  <input
                    type="file"
                    @change="handleFileUpload($event)"
                    accept="image/png,image/jpeg,image/jpg,image/gif"
                    class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm file:border-0 file:bg-transparent file:text-sm file:font-medium"
                  >
                </div>
                <p class="text-xs text-muted-foreground">Format: PNG, JPG, GIF. Maksimal 2MB</p>
                
                <!-- Logo Preview -->
                <div x-show="logoPreview" class="mt-4">
                  <p class="text-sm font-medium mb-2">Preview:</p>
                  <img :src="logoPreview" alt="Logo preview" class="h-24 w-24 object-contain border rounded-md">
                </div>
              </div>
            </div>

            <!-- Kerjasama Section -->
            <div class="space-y-4">
              <h2 class="text-lg font-semibold border-b pb-2">Kerjasama</h2>
              
              <div class="space-y-2">
                <label class="text-sm font-medium">Surat Kerjasama</label>
                <div class="flex items-center gap-4">
                  <input
                    type="file"
                    @change="handleCooperationLetterUpload($event)"
                    accept="application/pdf,image/png,image/jpeg,image/jpg"
                    class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm file:border-0 file:bg-transparent file:text-sm file:font-medium"
                  >
                </div>
                <p class="text-xs text-muted-foreground">Format: PDF, PNG, JPG. Maksimal 5MB</p>
                
                <!-- File Preview -->
                <div x-show="cooperationLetterFile" class="mt-4 p-4 border rounded-md bg-muted/30">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                      <!-- File Icon -->
                      <svg class="h-8 w-8 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      <div>
                        <p class="text-sm font-medium" x-text="cooperationLetterFile?.name"></p>
                        <p class="text-xs text-muted-foreground" x-text="formatFileSize(cooperationLetterFile?.size)"></p>
                      </div>
                    </div>
                    <!-- Remove Button -->
                    <button
                      type="button"
                      @click="removeCooperationLetter()"
                      class="text-destructive hover:text-destructive/80 transition-colors"
                    >
                      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Submit Button -->
            <div class="flex items-center gap-4 pt-4">
              <button
                type="submit"
                :disabled="isSubmitting"
                :class="isSubmitting ? 'opacity-50 cursor-not-allowed' : 'hover:bg-primary/90'"
                class="flex-1 inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground h-11 px-8 font-medium transition-colors"
              >
                <span x-show="!isSubmitting">Daftar Sekarang</span>
                <span x-show="isSubmitting" class="flex items-center gap-2">
                  <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                  Mendaftar...
                </span>
              </button>
            </div>

          </form>
        </div>
      </div>

      <!-- Additional Info -->
      <div class="mt-6 text-center text-sm text-muted-foreground">
        Sudah punya akun? 
        <a href="login.html" class="text-primary font-medium hover:underline">Login di sini</a>
      </div>

    </main>

    <!-- Footer -->
    <footer class="border-t mt-16 py-8">
      <div class="container mx-auto px-4 text-center text-sm text-muted-foreground">
        <p>© 2026 Kuotaumroh.id. All rights reserved.</p>
      </div>
    </footer>

    <!-- Toast Notification -->
    <div
      x-show="toastVisible"
      x-transition
      class="toast"
    >
      <div class="font-semibold mb-1" x-text="toastTitle"></div>
      <div class="text-sm text-muted-foreground" x-text="toastMessage"></div>
    </div>
  </div>

  <!-- Page Script -->
  <script>
    function signupApp() {
      return {
        // Form data
        formData: {
          email: '',
          phone: '',
          full_name: '',
          user_type: 'TRAVEL',
          travel_name: '',
          travel_type: '',
          travel_member: '',
          city: '',
          subdistrict: '',
          address: '',
          rt: '',
          rw: '',
          latitude: null,
          longitude: null,
        },

        // Logo upload
        logoFile: null,
        logoPreview: null,

        // Cooperation letter upload
        cooperationLetterFile: null,

        // UI state
        isSubmitting: false,
        toastVisible: false,
        toastTitle: '',
        toastMessage: '',

        // Regional data from CSV
        regionData: [],
        cities: [],
        subdistricts: [],
        allSubdistricts: [],

        // Map state
        mapInstance: null,
        marker: null,
        mapInitialized: false,

        async init() {
          // Get email from URL params (passed after Google auth)
          const urlParams = new URLSearchParams(window.location.search);
          const email = urlParams.get('email');
          
          if (email) {
            this.formData.email = email;
          } else {
            // If no email in URL, redirect to login for Google auth first
            this.showToast('Autentikasi Diperlukan', 'Silakan login dengan Google terlebih dahulu');
            setTimeout(() => {
              window.location.href = 'login.html';
            }, 2000);
          }
          
          // Load CSV data
          await this.loadRegionalData();
          
          console.log('Signup form initialized with email:', this.formData.email);
        },

        async loadRegionalData() {
          try {
            const response = await fetch('public/kodewilayah.csv');
            const csvText = await response.text();
            
            // Parse CSV
            const lines = csvText.trim().split('\n');
            const citiesSet = new Set();
            const subdistrictsMap = new Map();
            
            lines.forEach(line => {
              const [code, name] = line.split(',');
              if (!code || !name) return;
              
              // Count dots to determine level
              const dotCount = (code.match(/\./g) || []).length;
              
              // Level 1 (e.g., 11.01) = Kabupaten/Kota
              if (dotCount === 1) {
                citiesSet.add(name);
              }
              
              // Level 2 (e.g., 11.01.01) = Kecamatan
              if (dotCount === 2) {
                // Extract kabupaten code (e.g., "11.01" from "11.01.01")
                const cityCode = code.split('.').slice(0, 2).join('.');
                
                if (!subdistrictsMap.has(cityCode)) {
                  subdistrictsMap.set(cityCode, {
                    cityName: '',
                    subdistricts: []
                  });
                }
                subdistrictsMap.get(cityCode).subdistricts.push(name);
              }
            });
            
            // Second pass to map city codes to city names
            lines.forEach(line => {
              const [code, name] = line.split(',');
              if (!code || !name) return;
              
              const dotCount = (code.match(/\./g) || []).length;
              if (dotCount === 1) {
                if (subdistrictsMap.has(code)) {
                  subdistrictsMap.get(code).cityName = name;
                }
              }
            });
            
            // Convert to arrays
            this.cities = Array.from(citiesSet).sort();
            
            // Create a map from city name to subdistricts
            this.allSubdistricts = new Map();
            subdistrictsMap.forEach((value, code) => {
              if (value.cityName && value.subdistricts.length > 0) {
                this.allSubdistricts.set(value.cityName, value.subdistricts);
              }
            });
            
            console.log('Loaded', this.cities.length, 'cities');
            console.log('Loaded subdistricts for', this.allSubdistricts.size, 'cities');
          } catch (error) {
            console.error('Error loading regional data:', error);
            this.showToast('Error', 'Gagal memuat data wilayah');
          }
        },

        filteredCities(search) {
          if (!search) return this.cities;
          const searchLower = search.toLowerCase();
          return this.cities.filter(city => 
            city.toLowerCase().includes(searchLower)
          );
        },

        filteredSubdistricts(search) {
          if (!this.subdistricts.length) return [];
          if (!search) return this.subdistricts;
          const searchLower = search.toLowerCase();
          return this.subdistricts.filter(subdistrict => 
            subdistrict.toLowerCase().includes(searchLower)
          );
        },

        async handleCityChange() {
          // Reset subdistrict when city changes
          this.formData.subdistrict = '';
          
          // Load subdistricts for selected city
          this.subdistricts = this.allSubdistricts.get(this.formData.city) || [];
          
          console.log('City changed to:', this.formData.city);
          console.log('Loaded', this.subdistricts.length, 'subdistricts');
          
          // Initialize map if not already initialized
          this.$nextTick(async () => {
            if (!this.mapInitialized) {
              await this.initializeMap();
            } else if (this.formData.city) {
              // If map is already initialized, re-center to new city
              await this.recenterMapToCity();
            }
          });
        },

        async recenterMapToCity() {
          if (!this.mapInstance || !this.formData.city) return;
          
          try {
            // Use Nominatim API to geocode the city
            const searchQuery = `${this.formData.city}, Indonesia`;
            const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1`;
            
            const response = await fetch(geocodeUrl);
            const data = await response.json();
            
            if (data && data.length > 0) {
              const centerLat = parseFloat(data[0].lat);
              const centerLng = parseFloat(data[0].lon);
              
              // Fly to the new city location
              this.mapInstance.flyTo([centerLat, centerLng], 11, {
                duration: 1.5 // Animation duration in seconds
              });
              
              console.log('Map re-centered to:', this.formData.city, 'at', centerLat, centerLng);
            }
          } catch (error) {
            console.warn('Failed to re-center map:', error);
          }
        },

        async initializeMap() {
          // Prevent multiple initializations
          if (this.mapInitialized) return;
          
          // Default center: Indonesia (approximate center)
          let centerLat = -2.5;
          let centerLng = 118.0;
          let zoomLevel = 5;
          
          try {
            // If we have a selected city, geocode it to get coordinates
            if (this.formData.city) {
              try {
                // Use Nominatim API to geocode the city
                const searchQuery = `${this.formData.city}, Indonesia`;
                const geocodeUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=1`;
                
                const response = await fetch(geocodeUrl);
                const data = await response.json();
                
                if (data && data.length > 0) {
                  centerLat = parseFloat(data[0].lat);
                  centerLng = parseFloat(data[0].lon);
                  zoomLevel = 11; // Zoom to city level
                  console.log('Geocoded city:', this.formData.city, 'to', centerLat, centerLng);
                }
              } catch (geocodeError) {
                console.warn('Geocoding failed, using default center:', geocodeError);
              }
            }
            
            // Initialize the map
            this.mapInstance = L.map('map').setView([centerLat, centerLng], zoomLevel);
            
            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '© OpenStreetMap contributors',
              maxZoom: 19,
            }).addTo(this.mapInstance);
            
            // Create custom green icon for marker
            const greenIcon = L.icon({
              iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
              shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41]
            });
            
            // Add click event to drop/move marker
            this.mapInstance.on('click', (e) => {
              const { lat, lng } = e.latlng;
              
              // Update form data
              this.formData.latitude = lat;
              this.formData.longitude = lng;
              
              // Remove existing marker if any
              if (this.marker) {
                this.mapInstance.removeLayer(this.marker);
              }
              
              // Add new marker with green icon
              this.marker = L.marker([lat, lng], {
                draggable: true,
                icon: greenIcon
              }).addTo(this.mapInstance);
              
              // Update coordinates when marker is dragged
              this.marker.on('dragend', (event) => {
                const position = event.target.getLatLng();
                this.formData.latitude = position.lat;
                this.formData.longitude = position.lng;
              });
              
              console.log('Pin dropped at:', lat, lng);
            });
            
            this.mapInitialized = true;
            console.log('Map initialized successfully');
          } catch (error) {
            console.error('Error initializing map:', error);
            this.showToast('Error', 'Gagal memuat peta');
          }
        },

        handleFileUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          // Validate file size (max 2MB)
          if (file.size > 2 * 1024 * 1024) {
            this.showToast('Error', 'Ukuran file maksimal 2MB');
            event.target.value = '';
            return;
          }

          // Validate file type
          const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif'];
          if (!validTypes.includes(file.type)) {
            this.showToast('Error', 'Format file harus PNG, JPG, atau GIF');
            event.target.value = '';
            return;
          }

          this.logoFile = file;

          // Create preview
          const reader = new FileReader();
          reader.onload = (e) => {
            this.logoPreview = e.target.result;
          };
          reader.readAsDataURL(file);
        },

        handleCooperationLetterUpload(event) {
          const file = event.target.files[0];
          if (!file) return;

          // Validate file size (max 5MB)
          if (file.size > 5 * 1024 * 1024) {
            this.showToast('Error', 'Ukuran file maksimal 5MB');
            event.target.value = '';
            return;
          }

          // Validate file type
          const validTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg'];
          if (!validTypes.includes(file.type)) {
            this.showToast('Error', 'Format file harus PDF, PNG, atau JPG');
            event.target.value = '';
            return;
          }

          this.cooperationLetterFile = file;
          console.log('Cooperation letter uploaded:', file.name);
        },

        removeCooperationLetter() {
          this.cooperationLetterFile = null;
          // Reset the file input
          const fileInput = document.querySelector('input[type="file"][accept*="application/pdf"]');
          if (fileInput) fileInput.value = '';
        },

        formatFileSize(bytes) {
          if (!bytes) return '0 Bytes';
          const k = 1024;
          const sizes = ['Bytes', 'KB', 'MB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        },

        async handleSubmit() {
          this.isSubmitting = true;

          try {
            // Simulate API call
            await new Promise(resolve => setTimeout(resolve, 1500));

            // In a real implementation, you would send the data to your API
            console.log('Form data:', this.formData);
            console.log('Logo file:', this.logoFile);
            console.log('Cooperation letter file:', this.cooperationLetterFile);

            this.showToast('Berhasil!', 'Pendaftaran berhasil. Silakan cek email Anda untuk verifikasi.');
            
            // Reset form after successful submission
            setTimeout(() => {
              window.location.href = 'login.html';
            }, 2000);

          } catch (error) {
            console.error('Submission error:', error);
            this.showToast('Error', 'Terjadi kesalahan. Silakan coba lagi.');
          } finally {
            this.isSubmitting = false;
          }
        },

        showToast(title, message) {
          this.toastTitle = title;
          this.toastMessage = message;
          this.toastVisible = true;
          setTimeout(() => { this.toastVisible = false; }, 3000);
        }
      }
    }
  </script>

</body>
</html>
