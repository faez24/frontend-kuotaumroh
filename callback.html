<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Processing Login...</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="shared/utils.js"></script>
  <script src="shared/api.js"></script>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center">
  <div class="bg-white p-8 rounded-lg shadow-md max-w-md w-full text-center">
    <div class="mb-4 flex justify-center">
      <svg class="animate-spin h-10 w-10 text-emerald-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
    </div>
    <h2 class="text-xl font-semibold text-slate-800 mb-2">Memproses Login</h2>
    <p class="text-slate-500 text-sm" id="status-message">Mohon tunggu sebentar...</p>
    <div id="error-container" class="hidden mt-4 p-3 bg-red-50 text-red-600 rounded text-sm text-left">
      <p class="font-bold">Login Gagal</p>
      <p id="error-message">Terjadi kesalahan.</p>
      <a href="login.html" class="block mt-3 text-center bg-red-600 text-white py-2 rounded hover:bg-red-700 transition">Kembali ke Login</a>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const urlParams = new URLSearchParams(window.location.search);
      const code = urlParams.get('code');
      const statusEl = document.getElementById('status-message');
      const errorContainer = document.getElementById('error-container');
      const errorMsg = document.getElementById('error-message');
      
      if (!code) {
        statusEl.textContent = 'Kode otentikasi tidak ditemukan.';
        errorMsg.textContent = 'Tidak ada kode otentikasi dari Google.';
        errorContainer.classList.remove('hidden');
        return;
      }

      try {
        statusEl.textContent = 'Menghubungkan ke server...';
        
        // Call backend to exchange code
        const response = await handleGoogleCallback(code);
        
        // Check intent (login vs signup)
        const intent = sessionStorage.getItem('auth_intent') || 'login';
        sessionStorage.removeItem('auth_intent'); // Clean up

        console.log('Auth Response:', response);
        console.log('Intent:', intent);

        if (response.user) {
           // We have user data. 
           // If the backend auto-creates users, response.user will exist.
           // We need to decide where to go.

           // Scenario 1: User is fully registered (has ID, token, etc)
           if (response.token) {
             saveUser(response.user);
             
             // If intent was signup, but they are already registered (have token),
             // we just send them to dashboard.
             // If intent was login, send to dashboard.
             
             // However, Requirement 4 says: "if login & not registered -> Error".
             // Requirement 2 says: "signup -> fill email".
             
             // If the backend auto-creates users, we can't easily distinguish "not registered" 
             // unless the backend returns a flag like `is_new_user` or `created`.
             
             // Assuming the backend returns the user object.
             // Let's look at the user requirements again.
             // "Login -> check if email registered... if yes -> dashboard... if no -> error".
             
             // If the backend returns a token, it means the user IS registered (or auto-registered).
             // If the backend returns 404 or "not registered", the `handleGoogleCallback` (apiFetch) would likely throw.
             
             window.location.href = 'agent/dashboard.html';
             return;
           } 
           
           // Scenario 2: Backend returns user info (email) but NO token (meaning not registered?)
           // This depends on backend implementation.
           if (intent === 'signup') {
             // Redirect to signup with email
             window.location.href = `signup.html?email=${encodeURIComponent(response.user.email)}`;
           } else {
             // Intent is login, but no token?
             throw new Error('Akun anda belum terdaftar. Silakan daftar terlebih dahulu.');
           }

        } else if (response.email) {
            // Fallback if response structure is just { email: ... }
             if (intent === 'signup') {
               window.location.href = `signup.html?email=${encodeURIComponent(response.email)}`;
             } else {
               throw new Error('Akun anda belum terdaftar.');
             }
        } else {
             // Success but no user data?
             throw new Error('Respons server tidak valid.');
        }

      } catch (error) {
        console.error('Callback Error:', error);
        statusEl.textContent = 'Terjadi kesalahan.';
        
        // Handle specific error messages if possible
        // If the API throws 404/401 for unregistered users
        const message = error.message || 'Gagal memproses login Google.';
        
        // Special handling for "Not Registered" case if the backend throws it
        if (message.toLowerCase().includes('not found') || message.toLowerCase().includes('tidak ditemukan')) {
            if (sessionStorage.getItem('auth_intent_backup') === 'signup') {
                 // Try to recover email from error if possible, or just redirect to signup blank?
                 // Without email, we can't autofill.
                 window.location.href = 'signup.html';
                 return;
            }
            errorMsg.textContent = 'Akun anda belum terdaftar. Silakan pilih "Daftar sebagai Agen".';
        } else {
            errorMsg.textContent = message;
        }
        
        errorContainer.classList.remove('hidden');
      }
    });
  </script>
</body>
</html>