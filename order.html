<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pesanan Baru - Kuotaumroh.id</title>
  <!-- Favicon -->
  <link rel="apple-touch-icon" sizes="57x57" href="public/favicon/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="public/favicon/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="public/favicon/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="public/favicon/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="public/favicon/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="public/favicon/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="public/favicon/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="public/favicon/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="public/favicon/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192" href="public/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="public/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="public/favicon/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="public/favicon/favicon-16x16.png">
  <link rel="manifest" href="public/favicon/manifest.json">
  <meta name="msapplication-TileColor" content="#10b981">
  <meta name="msapplication-TileImage" content="public/favicon/ms-icon-144x144.png">
  <meta name="theme-color" content="#10b981">


  <!-- Google Fonts - Figtree -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Alpine.js for reactivity -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Shared CSS -->
  <link rel="stylesheet" href="shared/styles.css">

  <!-- Shared JS -->
  <script src="shared/header.js"></script>

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            border: "hsl(var(--border))",
            input: "hsl(var(--input))",
            ring: "hsl(var(--ring))",
            background: "hsl(var(--background))",
            foreground: "hsl(var(--foreground))",
            primary: {
              DEFAULT: "hsl(var(--primary))",
              foreground: "hsl(var(--primary-foreground))",
            },
            secondary: {
              DEFAULT: "hsl(var(--secondary))",
              foreground: "hsl(var(--secondary-foreground))",
            },
            destructive: {
              DEFAULT: "hsl(var(--destructive))",
              foreground: "hsl(var(--destructive-foreground))",
            },
            muted: {
              DEFAULT: "hsl(var(--muted))",
              foreground: "hsl(var(--muted-foreground))",
            },
            accent: {
              DEFAULT: "hsl(var(--accent))",
              foreground: "hsl(var(--accent-foreground))",
            },
            success: {
              DEFAULT: "hsl(var(--success))",
              foreground: "hsl(var(--success-foreground))",
            },
          },
          fontFamily: {
            sans: ['Figtree', 'ui-sans-serif', 'system-ui', '-apple-system', 'sans-serif'],
          },
          borderRadius: {
            lg: "var(--radius)",
            md: "calc(var(--radius) - 2px)",
            sm: "calc(var(--radius) - 4px)",
          },
        },
      },
    }
  </script>
</head>

<body class="min-h-screen bg-background">
  <!-- Alpine.js Main App -->
  <div x-data="orderApp()">

    <!-- Shared Header Component -->
    <div id="app-header"></div>

    <!-- Main Content -->
    <main class="container mx-auto py-6 animate-fade-in px-4">
      <!-- Page Header -->
      <div class="mb-6">
        <h1 class="text-3xl font-bold tracking-tight">Pesanan Baru</h1>
        <p class="text-muted-foreground mt-2">Buat pesanan kuota umroh baru</p>
      </div>

      <div class="grid gap-6 lg:grid-cols-3">
        <!-- Main Form (2/3) -->
        <div class="lg:col-span-2 space-y-6">

          <!-- Input Method Card -->
          <div class="rounded-lg border bg-white shadow-sm">
            <div class="p-6 border-b">
              <h3 class="text-lg font-semibold">Pilih Metode Input</h3>
            </div>
            <div class="p-6">
              <!-- Tab Buttons -->
              <div class="grid grid-cols-2 gap-1 p-1 bg-muted rounded-lg mb-6">
                <button
                  @click="mode = 'bulk'"
                  :class="mode === 'bulk' ? 'bg-white shadow-sm' : 'hover:bg-white/50'"
                  class="py-2 px-4 rounded-md text-sm font-medium transition-all"
                >
                  Input Massal
                </button>
                <button
                  @click="mode = 'individual'"
                  :class="mode === 'individual' ? 'bg-white shadow-sm' : 'hover:bg-white/50'"
                  class="py-2 px-4 rounded-md text-sm font-medium transition-all"
                >
                  Input Individu
                </button>
              </div>

              <!-- Bulk Mode -->
              <div x-show="mode === 'bulk'" class="space-y-4">
                <div class="space-y-2">
                  <div class="flex items-center justify-between">
                    <label for="bulk-input" class="text-sm font-medium">Daftar Nomor</label>
                    <input type="file" @change="handleFileUpload($event)" accept=".csv,.txt" class="hidden" x-ref="fileInput">
                    <button @click="$refs.fileInput.click()" class="inline-flex items-center rounded-md border bg-background h-9 px-3 text-sm hover:bg-muted">
                      <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                      </svg>
                      Upload File
                    </button>
                  </div>
                  <textarea
                    id="bulk-input"
                    x-model="bulkInput"
                    @input="parseBulkNumbers()"
                    aria-label="Masukkan nomor telepon, pisahkan dengan enter atau koma"
                    aria-describedby="bulk-input-help"
                    placeholder="Masukkan nomor telepon, satu per baris atau pisahkan dengan koma..."
                    rows="6"
                    class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono"
                  ></textarea>
                  <p id="bulk-input-help" class="text-xs text-muted-foreground">
                    Format: 08xx-xxxx-xxxx atau 628xxxxxxxxxx
                  </p>
                  <div class="flex items-center gap-4 text-sm">
                    <span class="text-muted-foreground" x-text="parsedNumbers.length + ' nomor terdeteksi'"></span>
                    <template x-if="validCount > 0">
                      <span class="badge badge-primary" x-text="validCount + ' valid'"></span>
                    </template>
                    <template x-if="invalidCount > 0">
                      <span @click="invalidDialogOpen = true" class="badge badge-destructive cursor-pointer flex items-center gap-1">
                        <svg class="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                        <span x-text="invalidCount + ' tidak valid'"></span>
                      </span>
                    </template>
                  </div>
                </div>

                <!-- Provider Groups Table -->
                <template x-if="Object.keys(providerGroups).length > 0">
                  <div class="rounded-lg border">
                    <div class="p-4 border-b">
                      <h4 class="font-medium">Pilih Paket per Provider</h4>
                    </div>
                    <div class="overflow-x-auto">
                      <table class="w-full">
                        <thead>
                          <tr class="border-b">
                            <th class="h-10 px-4 text-left text-sm font-medium text-muted-foreground">Provider</th>
                            <th class="h-10 px-4 text-center text-sm font-medium text-muted-foreground">Jumlah</th>
                            <th class="h-10 px-4 text-left text-sm font-medium text-muted-foreground">Paket</th>
                            <th class="h-10 px-4 text-right text-sm font-medium text-muted-foreground">Harga Paket</th>
                            <th class="h-10 px-4 text-right text-sm font-medium text-muted-foreground">Harga Jual</th>
                          </tr>
                        </thead>
                        <tbody>
                          <template x-for="(numbers, provider) in providerGroups" :key="provider">
                            <tr 
                              class="border-b transition-colors"
                              :class="validationError && getUnassignedNumbers(provider).length > 0 ? 'bg-destructive/10 border-l-4 border-l-destructive' : ''"
                            >
                              <td class="p-4 font-medium" x-text="provider"></td>
                              <td class="p-4 text-center" x-text="numbers.length"></td>
                              <td class="p-4">
                                <div class="flex items-start gap-2">
                                  <button
                                    type="button"
                                    @click.stop="openPackagePicker(provider)"
                                    class="flex-1 w-full min-h-[40px] h-auto py-2 px-3 rounded-md border border-input bg-background text-left flex items-center justify-between hover:bg-muted/50 cursor-pointer transition-colors"
                                  >
                                    <div class="flex-1">
                                      <template x-if="!getProviderAssignments(provider).length">
                                        <span class="text-muted-foreground">Pilih paket</span>
                                      </template>
                                      <template x-if="getProviderAssignments(provider).length > 0">
                                        <div class="flex flex-wrap gap-1">
                                          <template x-for="assignment in getProviderAssignments(provider)" :key="assignment.packageId">
                                            <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-primary/10 text-primary text-xs rounded-md">
                                              <span x-text="getPackageName(assignment.packageId)"></span>
                                              (<span x-text="assignment.numbers.length"></span>)
                                            </span>
                                          </template>
                                          <template x-if="getUnassignedNumbers(provider).length > 0">
                                            <span class="inline-flex items-center px-2 py-0.5 bg-muted text-muted-foreground text-xs rounded-md">
                                              +<span x-text="getUnassignedNumbers(provider).length"></span> belum dipilih
                                            </span>
                                          </template>
                                        </div>
                                      </template>
                                    </div>
                                    <svg class="h-4 w-4 shrink-0 opacity-50 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                  </button>
                                  <button type="button" @click.stop="openNumberListDialog(provider)" class="p-2 hover:bg-muted rounded-md" title="Edit Nomor">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                                    </svg>
                                  </button>
                                </div>
                              </td>
                              <td class="p-4 text-right font-medium">
                                <span x-text="getProviderSubtotal(provider) > 0 ? formatRupiah(getProviderSubtotal(provider)) : '-'"></span>
                              </td>
                              <td class="p-4 text-right">
                                <template x-if="getProviderSellTotal(provider) > 0">
                                  <div class="space-y-0.5">
                                    <div class="font-medium" x-text="formatRupiah(getProviderSellTotal(provider))"></div>
                                    <div class="text-xs text-primary font-medium">
                                      (Profit +<span x-text="formatRupiah(getProviderProfit(provider))"></span>)
                                    </div>
                                  </div>
                                </template>
                                <template x-if="getProviderSellTotal(provider) === 0">
                                  <span>-</span>
                                </template>
                              </td>
                            </tr>
                          </template>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </template>
              </div>

              <!-- Individual Mode -->
              <div x-show="mode === 'individual'" class="space-y-4">
                <div class="rounded-lg border">
                  <div class="p-4 border-b">
                    <h4 class="font-medium">Daftar Nomor</h4>
                  </div>
                  <div class="p-4 space-y-3">
                    <template x-for="(item, index) in individualItems" :key="item.id">
                      <div 
                        class="flex items-center gap-3 p-3 rounded-lg transition-colors"
                        :class="validationError && item.provider && !item.packageId ? 'bg-destructive/10 border-2 border-destructive' : ''"
                      >
                        <span class="text-sm text-muted-foreground w-6" x-text="(index + 1) + '.'"></span>
                        <div class="relative flex-1">
                          <input
                            type="text"
                            placeholder="Nomor telepon"
                            x-model="item.msisdn"
                            @input="item.provider = detectProviderForItem(item)"
                            class="flex h-10 w-full rounded-md border border-input bg-background px-3 pr-24 py-2 text-sm font-mono"
                          >
                          <template x-if="item.provider">
                            <span class="absolute right-2 top-1/2 -translate-y-1/2 badge badge-secondary text-xs" x-text="item.provider"></span>
                          </template>
                        </div>
                        <button
                          type="button"
                          @click="openIndividualPackagePicker(item)"
                          :disabled="!item.provider"
                          :class="item.provider ? 'hover:bg-muted/50' : 'opacity-50 cursor-not-allowed'"
                          class="flex h-10 w-48 rounded-md border border-input bg-background px-3 py-2 text-sm text-left flex items-center justify-between"
                        >
                          <span :class="item.packageId ? '' : 'text-muted-foreground'" x-text="item.packageId ? getPackageName(item.packageId) : 'Pilih paket'"></span>
                          <svg class="h-4 w-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                          </svg>
                        </button>
                        <button @click="removeIndividualItem(item.id)" :disabled="individualItems.length === 1" class="p-2 hover:bg-muted rounded-md disabled:opacity-50">
                          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        </button>
                      </div>
                    </template>
                    <button @click="addIndividualItem()" class="w-full inline-flex items-center justify-center rounded-md border bg-background h-10 px-4 hover:bg-muted">
                      <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                      </svg>
                      Tambah Nomor
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Activation Time Card -->
          <template x-if="itemCount > 0">
            <div class="rounded-lg border bg-white shadow-sm">
              <div class="p-6 border-b">
                <h3 class="text-lg font-semibold flex items-center gap-2">
                  <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  Pilih Waktu Aktivasi
                </h3>
              </div>
              <div class="p-6 space-y-4">
                <div class="grid grid-cols-2 gap-2">
                  <button
                    @click="activationTime = 'now'"
                    :class="activationTime === 'now' ? 'bg-primary text-primary-foreground' : 'border hover:bg-muted'"
                    class="h-12 rounded-md font-medium transition-colors"
                  >
                    AKTIFKAN LANGSUNG
                  </button>
                  <button
                    @click="activationTime = 'scheduled'"
                    :class="activationTime === 'scheduled' ? 'bg-primary text-primary-foreground' : 'border hover:bg-muted'"
                    class="h-12 rounded-md font-medium transition-colors"
                  >
                    PILIH JADWAL AKTIVASI
                  </button>
                </div>

                <template x-if="activationTime === 'scheduled'">
                  <div class="space-y-4">
                    <div class="space-y-2">
                      <label class="text-xs text-muted-foreground uppercase tracking-wide">Pilih Tanggal</label>
                      <input type="date" x-model="scheduledDate" :min="todayDate" class="flex h-12 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                    </div>
                    <div class="space-y-2">
                      <label class="text-xs text-muted-foreground uppercase tracking-wide">Pilih Waktu (WIB)</label>
                      <input type="time" x-model="scheduledTime" class="flex h-12 w-full rounded-md border border-input bg-background px-3 py-2 text-sm">
                      <div class="flex gap-2">
                        <template x-for="time in quickTimes" :key="time">
                          <button
                            @click="scheduledTime = time"
                            :class="scheduledTime === time ? 'bg-primary text-primary-foreground' : 'border hover:bg-muted'"
                            class="flex-1 py-2 rounded-md text-sm font-medium transition-colors"
                            x-text="time"
                          ></button>
                        </template>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </template>

          <!-- Payment Method Card -->
          <template x-if="itemCount > 0">
            <div class="rounded-lg border bg-white shadow-sm">
              <div class="p-6 border-b">
                <h3 class="text-lg font-semibold">Metode Pembayaran</h3>
              </div>
              <div class="p-6 space-y-3">
                <template x-for="method in paymentMethods" :key="method.id">
                  <label
                    :class="paymentMethod === method.id ? 'border-primary bg-primary/5' : 'hover:bg-muted/50'"
                    class="flex items-center gap-4 p-4 border rounded-lg cursor-pointer transition-colors"
                  >
                    <input type="radio" :value="method.id" x-model="paymentMethod" class="h-4 w-4 text-primary">
                    <div class="rounded-full bg-muted p-2">
                      <svg class="h-5 w-5 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" :d="method.icon" />
                      </svg>
                    </div>
                    <div class="flex-1">
                      <p class="font-medium" x-text="method.name"></p>
                      <p class="text-sm text-muted-foreground" x-text="method.description"></p>
                    </div>
                    <template x-if="method.id === 'wallet'">
                      <div class="text-right">
                        <p class="text-sm font-medium" x-text="formatRupiah(walletBalance)"></p>
                        <template x-if="walletBalance < totalWithFee">
                          <p class="text-xs text-destructive">Saldo tidak cukup</p>
                        </template>
                      </div>
                    </template>
                  </label>
                </template>
              </div>
            </div>
          </template>
        </div>

        <!-- Order Summary Sidebar (1/3) -->
        <div class="lg:col-span-1">
          <div class="rounded-lg border bg-white shadow-sm sticky top-24">
            <div class="p-6 border-b">
              <h3 class="text-lg font-semibold flex items-center gap-2">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                Ringkasan Pembayaran
              </h3>
            </div>
            <div class="p-6 space-y-4">
              <!-- Batch Info -->
              <div class="space-y-2 pb-4 border-b">
                <div class="flex justify-between items-center text-sm">
                  <span class="text-muted-foreground">Batch ID</span>
                  <span class="font-mono text-xs" x-text="batchId"></span>
                </div>
                <div class="flex justify-between items-center text-sm">
                  <span class="text-muted-foreground">Nama Batch</span>
                  <div class="flex items-center gap-2">
                    <span class="font-medium" x-text="batchName"></span>
                    <button 
                      @click="editBatchNameDialog = true"
                      class="text-primary hover:text-primary/80 transition-colors"
                      title="Edit nama batch"
                    >
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Price Breakdown -->
              <div class="space-y-2">
                <div class="flex justify-between text-sm">
                  <span class="text-muted-foreground">Subtotal (<span x-text="itemCount"></span> nomor)</span>
                  <span x-text="formatRupiah(subtotal)"></span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-muted-foreground">Biaya Platform</span>
                  <span x-text="formatRupiah(platformFee)"></span>
                </div>
                <div class="flex justify-between text-sm">
                  <span class="text-muted-foreground">Keuntungan</span>
                  <span class="font-medium text-primary">+<span x-text="formatRupiah(profit)"></span></span>
                </div>
              </div>
              <div class="border-t pt-4">
                <div class="flex justify-between">
                  <span class="font-medium">Total Pembayaran</span>
                  <span class="text-xl font-bold" x-text="formatRupiah(totalWithFee)"></span>
                </div>
              </div>
              <button
                @click="handleConfirmOrder()"
                :disabled="itemCount === 0 || subtotal === 0 || isProcessing"
                :class="(itemCount > 0 && subtotal > 0) ? 'bg-primary text-primary-foreground hover:bg-primary/90' : 'bg-muted text-muted-foreground cursor-not-allowed'"
                class="w-full h-12 rounded-md font-medium transition-colors flex items-center justify-center gap-2"
              >
                <template x-if="isProcessing">
                  <span>Memproses...</span>
                </template>
                <template x-if="!isProcessing">
                  <span>
                    <svg class="inline h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Konfirmasi Pesanan
                  </span>
                </template>
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Loading Overlay -->
    <div x-show="packagesLoading" x-cloak class="fixed inset-0 z-50 flex items-center justify-center bg-black/30">
      <div class="bg-white rounded-lg p-8 shadow-lg flex flex-col items-center gap-4">
        <svg class="animate-spin h-12 w-12 text-primary" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-sm font-medium">Memuat data paket...</p>
      </div>
    </div>

    <!-- Toast Notification -->
    <div x-show="toastVisible" x-transition class="toast">
      <div class="font-semibold mb-1" x-text="toastTitle"></div>
      <div class="text-sm text-muted-foreground" x-text="toastMessage"></div>
    </div>

    <!-- DEBUG: State Display (REMOVE THIS LATER) -->
    <!-- <div class="fixed bottom-4 left-4 bg-black text-white p-4 rounded text-xs font-mono z-[9999]">
      <div>packagePickerOpen: <span x-text="packagePickerOpen"></span></div>
      <div>numberSelectionOpen: <span x-text="numberSelectionOpen"></span></div>
      <div>numberListDialogOpen: <span x-text="numberListDialogOpen"></span></div>
      <div>pickerProvider: <span x-text="pickerProvider"></span></div>
    </div> -->

    <!-- Leave Page Confirmation Dialog -->
    <div
      x-show="showLeaveConfirmation"
      x-cloak
      class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50"
      @click.self="showLeaveConfirmation = false"
    >
      <div class="relative bg-white rounded-lg shadow-lg w-full max-w-md animate-fade-in">
        <!-- Dialog Header -->
        <div class="p-6">
          <div class="flex items-start gap-4">
            <div class="rounded-full bg-destructive/10 p-3">
              <svg class="h-6 w-6 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
            </div>
            <div class="flex-1">
              <h2 class="text-lg font-semibold mb-1">Batal membuat order?</h2>
              <p class="text-sm text-muted-foreground">
                Nomor dan paket terpilih tidak akan tersimpan
              </p>
            </div>
          </div>
        </div>

        <!-- Dialog Footer -->
        <div class="p-6 border-t flex gap-3">
          <button
            type="button"
            @click="cancelLeave()"
            class="flex-1 inline-flex items-center justify-center rounded-md border bg-background h-10 px-4 py-2 hover:bg-muted transition-colors font-medium"
          >
            Kembali
          </button>
          <button
            type="button"
            @click="confirmLeave()"
            class="flex-1 inline-flex items-center justify-center rounded-md bg-destructive text-destructive-foreground h-10 px-4 py-2 hover:bg-destructive/90 transition-colors font-medium"
          >
            Batalkan Order
          </button>
        </div>
      </div>
    </div>


    <!-- Edit Batch Name Dialog -->
    <div
      x-show="editBatchNameDialog"
      x-cloak
      @click.self="editBatchNameDialog = false"
      x-init="$watch('editBatchNameDialog', value => { if(value) tempBatchName = batchName })"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
    >
      <div class="relative bg-white rounded-lg shadow-lg w-full max-w-md animate-fade-in">
        <!-- Dialog Header -->
        <div class="p-6 border-b">
          <h2 class="text-lg font-semibold">Edit Nama Batch</h2>
          <p class="text-sm text-muted-foreground mt-1">
            Ubah nama batch untuk memudahkan identifikasi pesanan
          </p>
        </div>

        <!-- Dialog Body -->
        <div class="p-6">
          <div class="space-y-2">
            <label for="batchNameInput" class="text-sm font-medium">Nama Batch</label>
            <input
              id="batchNameInput"
              type="text"
              x-model="tempBatchName"
              @keydown.enter="saveBatchName()"
              class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
              placeholder="Contoh: Jamaah Umroh 15 Januari 2026"
            >
          </div>
        </div>

        <!-- Dialog Footer -->
        <div class="p-6 border-t flex gap-3">
          <button
            type="button"
            @click="editBatchNameDialog = false"
            class="flex-1 inline-flex items-center justify-center rounded-md border bg-background h-10 px-4 py-2 hover:bg-muted transition-colors"
          >
            Batal
          </button>
          <button
            type="button"
            @click="saveBatchName()"
            class="flex-1 inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground h-10 px-4 py-2 hover:bg-primary/90 transition-colors"
          >
            Simpan
          </button>
        </div>
      </div>
    </div>

    <!-- Invalid Numbers Dialog -->
    <div
      x-show="invalidDialogOpen"
      x-cloak
      role="dialog"
      aria-labelledby="invalid-dialog-title"
      aria-modal="true"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
      @click.self="invalidDialogOpen = false"
      @keydown.escape="invalidDialogOpen = false"
    >
      <div class="relative bg-white rounded-lg shadow-lg w-full max-w-md max-h-[80vh] overflow-hidden animate-fade-in">
        <div class="p-6 border-b">
          <h2 id="invalid-dialog-title" class="text-lg font-semibold">Nomor Tidak Valid</h2>
          <p class="text-sm text-muted-foreground mt-1" x-text="invalidNumbers.length + ' nomor tidak dapat diproses'"></p>
        </div>
        <div class="p-4 max-h-[50vh] overflow-y-auto space-y-2">
          <template x-for="num in invalidNumbers" :key="num.msisdn">
            <div class="flex items-center justify-between p-2 bg-muted/50 rounded-md">
              <span class="font-mono text-sm" x-text="num.msisdn"></span>
              <button @click="deleteInvalidNumber(num.msisdn)" class="text-destructive hover:bg-destructive/10 p-1 rounded">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </template>
        </div>
        <div class="p-4 border-t flex gap-3">
          <button @click="invalidDialogOpen = false" class="flex-1 inline-flex items-center justify-center rounded-md border bg-background h-10 px-4 hover:bg-muted">
            Tutup
          </button>
          <button @click="deleteAllInvalidNumbers()" class="flex-1 inline-flex items-center justify-center rounded-md h-10 px-4 bg-destructive text-destructive-foreground hover:bg-destructive/90">
            Hapus Semua
          </button>
        </div>
      </div>
    </div>

    <!-- Number List Edit Dialog (Daftar Nomor Provider) -->
    <div
      x-show="numberListDialogOpen"
      x-cloak
      role="dialog"
      aria-labelledby="number-list-dialog-title"
      aria-modal="true"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
      @click.self="numberListDialogOpen = false"
      @keydown.escape="numberListDialogOpen = false"
    >
      <div class="relative bg-white rounded-lg shadow-lg w-full max-w-xl max-h-[80vh] overflow-hidden animate-fade-in">
        <!-- Header -->
        <div class="p-6 border-b flex items-center justify-between">
          <h2 id="number-list-dialog-title" class="text-lg font-semibold">Daftar Nomor <span x-text="editingProvider"></span></h2>
          <button @click="numberListDialogOpen = false" class="p-2 hover:bg-muted rounded-md">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <!-- Table Header -->
        <div class="px-6 py-3 border-b bg-muted/30">
          <div class="flex items-center">
            <span class="w-1/2 text-sm font-medium text-muted-foreground">Nomor HP</span>
            <span class="w-1/2 text-sm font-medium text-muted-foreground">Paket</span>
          </div>
        </div>
        
        <!-- Number List with Package Dropdowns -->
        <div class="max-h-[50vh] overflow-y-auto">
          <template x-for="num in getEditingNumbers()" :key="num">
            <div class="flex items-center px-6 py-3 border-b hover:bg-muted/10">
              <!-- Phone Number -->
              <span class="w-1/2 font-mono text-sm" x-text="num"></span>
              <!-- Package Picker Button -->
              <div class="w-1/2 flex items-center gap-2">
                <button
                  @click="openSingleNumberPackagePicker(editingProvider, num)"
                  class="flex-1 h-9 rounded-md border border-input bg-background px-3 text-sm text-left hover:bg-muted/50 flex items-center justify-between"
                >
                  <span :class="getNumberPackageId(editingProvider, num) ? '' : 'text-muted-foreground'" x-text="getNumberPackageId(editingProvider, num) ? getPackageName(getNumberPackageId(editingProvider, num)) : 'Pilih paket'"></span>
                  <svg class="h-4 w-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </button>
                <button @click="deleteNumberFromProvider(editingProvider, num)" class="p-1.5 text-destructive hover:bg-destructive/10 rounded">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                </button>
              </div>
            </div>
          </template>
        </div>
        
        <!-- Footer with Total and Save Button -->
        <div class="p-4 border-t flex items-center justify-between">
          <p class="text-sm text-muted-foreground">
            <span x-text="getEditingNumbers().length"></span> nomor â€¢ Total: <span class="font-semibold text-foreground" x-text="formatRupiah(getTempEditingSubtotal())"></span>
          </p>
          <div class="flex gap-2">
            <button @click="numberListDialogOpen = false" class="inline-flex items-center justify-center rounded-md border bg-background h-10 px-4 hover:bg-muted text-sm">
              Tutup
            </button>
            <template x-if="hasUnsavedChanges">
              <button 
                @click="saveListChanges()"
                class="inline-flex items-center justify-center rounded-md bg-primary text-primary-foreground h-10 px-4 hover:bg-primary/90 text-sm font-medium animate-fade-in"
              >
                Simpan Perubahan
              </button>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- Package Picker Dialog - Step 1: PILIH PAKET -->
    <div
      x-show="packagePickerOpen && !numberSelectionOpen"
      x-cloak
      x-transition
      role="dialog"
      aria-labelledby="package-picker-dialog-title"
      aria-modal="true"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
      @click.self="packagePickerOpen = false"
      @keydown.escape="packagePickerOpen = false"
    >
      <div class="relative bg-white rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] overflow-hidden animate-fade-in">
        <!-- Header -->
        <div class="p-6 border-b flex items-center justify-between">
          <h2 id="package-picker-dialog-title" class="text-xl font-bold">PILIH PAKET</h2>
          <button @click="packagePickerOpen = false" class="p-2 hover:bg-muted rounded-md">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <!-- Search & Filters -->
        <div class="p-4 border-b space-y-4">
          <!-- Search -->
          <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input 
              type="text" 
              x-model="packageSearch"
              placeholder="Cari paket" 
              class="w-full h-10 pl-10 pr-4 rounded-md border border-input bg-background text-sm"
            >
          </div>
          <!-- Duration Filter Tabs -->
          <div class="flex gap-2 flex-wrap">
            <template x-for="filter in durationFilters" :key="filter.value">
              <button 
                @click="selectedDurationFilter = filter.value"
                :class="selectedDurationFilter === filter.value ? 'bg-primary text-primary-foreground' : 'bg-muted hover:bg-muted/80'"
                class="px-4 py-2 rounded-md text-sm font-medium transition-colors"
                x-text="filter.label"
              ></button>
            </template>
          </div>
        </div>
        
        <!-- Package Cards Grid -->
        <div class="p-4 max-h-[50vh] overflow-y-auto">
          <!-- Empty State -->
          <template x-if="getFilteredPackages().length === 0">
            <div class="flex flex-col items-center justify-center py-12 text-center">
              <svg class="h-16 w-16 text-muted-foreground/50 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
              </svg>
              <h3 class="text-lg font-semibold mb-2">Tidak ada paket yang ditemukan</h3>
              <p class="text-sm text-muted-foreground mb-6" x-text="'Tidak ada paket tersedia untuk provider ' + pickerProviderDisplay"></p>
              <button
                @click="deleteProviderNumbers(pickerProvider); packagePickerOpen = false;"
                class="inline-flex items-center rounded-md h-10 px-4 bg-destructive text-destructive-foreground hover:bg-destructive/90 font-medium"
              >
                <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                <span x-text="'Hapus ' + (providerGroups[pickerProvider]?.length || 0) + ' Nomor dari ' + pickerProviderDisplay"></span>
              </button>
            </div>
          </template>

          <!-- Package Grid -->
          <div x-show="getFilteredPackages().length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <template x-for="pkg in getFilteredPackages()" :key="pkg.id">
              <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                <!-- Header with type and profit badge -->
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs text-muted-foreground font-medium" x-text="pickerProviderDisplay"></span>
                  <span class="text-xs font-semibold text-primary">Profit <span x-text="formatRupiah(pkg.sellPrice - pkg.price)"></span></span>
                </div>
                <!-- Package Name -->
                <h3 class="font-semibold mb-1" x-text="pkg.name"></h3>
                <!-- Details -->
                <p class="text-sm text-muted-foreground mb-3" x-text="pkg.days + ' hari'"></p>
                <!-- Price -->
                <p class="text-xl font-bold mb-1" x-text="formatRupiah(pkg.price)"></p>
                <p class="text-xs text-muted-foreground mb-3">Harga Jual: <span x-text="formatRupiah(pkg.sellPrice)"></span></p>
                <!-- PILIH Button -->
                <button
                  @click="selectPackageAndOpenNumberSelection(pkg)"
                  class="w-full h-10 rounded-md bg-primary text-primary-foreground font-medium hover:bg-primary/90 transition-colors"
                >
                  PILIH
                </button>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- Package Picker Dialog - Step 2: PILIH NOMOR -->
    <div
      x-show="packagePickerOpen && numberSelectionOpen"
      x-cloak
      role="dialog"
      aria-labelledby="number-selection-dialog-title"
      aria-modal="true"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black/50"
      @click.self="closeNumberSelection()"
      @keydown.escape="closeNumberSelection()"
    >
      <div class="relative bg-white rounded-lg shadow-lg w-full max-w-xl max-h-[90vh] overflow-hidden animate-fade-in">
        <!-- Header -->
        <div class="p-6 border-b flex items-center gap-4">
          <button @click="closeNumberSelection()" class="p-2 hover:bg-muted rounded-md">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
          </button>
          <h2 id="number-selection-dialog-title" class="text-xl font-bold">PILIH NOMOR</h2>
          <div class="flex-1"></div>
          <button @click="closeNumberSelection(); packagePickerOpen = false;" class="p-2 hover:bg-muted rounded-md">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        
        <!-- Selected Package Info -->
        <div class="px-6 py-4 bg-muted/30 border-b">
          <p class="text-sm text-muted-foreground">Paket dipilih:</p>
          <p class="font-semibold" x-text="selectedPackageForNumbers?.name"></p>
          <p class="text-primary font-medium" x-text="formatRupiah(selectedPackageForNumbers?.price || 0) + ' / nomor'"></p>
        </div>
        
        <!-- Search -->
        <div class="p-4 border-b">
          <div class="relative">
            <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input 
              type="text" 
              x-model="numberSearch"
              placeholder="Cari nomor..." 
              class="w-full h-10 pl-10 pr-4 rounded-md border border-input bg-background text-sm"
            >
          </div>
        </div>
        
        <!-- Select All -->
        <div class="px-4 py-3 border-b">
          <label class="flex items-center gap-3 cursor-pointer">
            <input 
              type="checkbox" 
              :checked="areAllNumbersSelected()"
              @change="toggleSelectAllNumbers()"
              class="h-4 w-4 rounded border-primary text-primary"
            >
            <span class="font-medium text-primary">Pilih Semua (<span x-text="getPickerNumbers().length"></span> nomor)</span>
          </label>
        </div>
        
        <!-- Number List -->
        <div class="max-h-[40vh] overflow-y-auto">
          <template x-for="(num, index) in getFilteredPickerNumbers()" :key="num">
            <label 
              class="flex items-center gap-3 px-4 py-3 border-b cursor-pointer hover:bg-muted/30 transition-colors"
              :class="tempSelectedNumbers.includes(num) ? 'bg-primary/5' : ''"
            >
              <input 
                type="checkbox" 
                :checked="tempSelectedNumbers.includes(num)"
                @change="toggleNumberSelection(num)"
                class="h-4 w-4 rounded border-primary text-primary"
              >
              <span class="text-sm text-muted-foreground" x-text="(index + 1) + '.'"></span>
              <span class="font-mono" x-text="num"></span>
              <!-- Show existing package badge if assigned -->
              <template x-if="getNumberCurrentPackage(num)">
                <span class="ml-auto px-2 py-1 bg-primary/10 text-primary text-xs rounded-md" x-text="getNumberCurrentPackage(num)"></span>
              </template>
            </label>
          </template>
        </div>
        
        <!-- Footer -->
        <div class="p-4 border-t flex items-center justify-between">
          <span class="text-sm text-muted-foreground">
            <span x-text="tempSelectedNumbers.length"></span> dari <span x-text="getPickerNumbers().length"></span> nomor dipilih
          </span>
          <button 
            @click="applyNumberSelection()"
            :disabled="tempSelectedNumbers.length === 0"
            :class="tempSelectedNumbers.length > 0 ? 'bg-primary text-primary-foreground hover:bg-primary/90' : 'bg-muted text-muted-foreground cursor-not-allowed'"
            class="h-10 px-6 rounded-md font-medium transition-colors"
          >
            Terapkan (<span x-text="formatRupiah(tempSelectedNumbers.length * (selectedPackageForNumbers?.price || 0))"></span>)
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Alpine.js Application Logic -->
  <script>
    function orderApp() {
      return {
        // User data
        user: { name: '', email: '', agentCode: '', initials: '' },

        // Mode
        mode: 'bulk',

        // Bulk input
        bulkInput: '',
        parsedNumbers: [],
        providerGroups: {},

        // Individual input
        individualItems: [{ id: '1', msisdn: '', packageId: '', provider: null }],

        // Packages from API
        packages: [],
        packagesLoading: true,

        // Checkout
        activationTime: 'now',
        scheduledDate: '',
        scheduledTime: '',
        paymentMethod: 'qris',
        quickTimes: ['02:00', '04:00', '13:00', '22:00'],

        // Payment methods
        paymentMethods: [
          { id: 'qris', name: 'QRIS', description: 'Bayar dengan QRIS', icon: 'M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z' },
          { id: 'wallet', name: 'Saldo Dompet', description: 'Bayar dengan saldo dompet Anda', icon: 'M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z' },
          { id: 'bank', name: 'Transfer Bank', description: 'BCA, Mandiri, BNI, BRI', icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4' },
          { id: 'va', name: 'Virtual Account', description: 'Bayar via Virtual Account', icon: 'M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z' },
        ],

        // Wallet balance
        walletBalance: 3250000,
        platformFee: 0,

        // Batch info
        batchId: 'BATCH-' + Date.now(),
        batchName: `Order ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`,
        editBatchNameDialog: false,
        tempBatchName: '',

        // Processing
        isProcessing: false,

        // Leave confirmation
        showLeaveConfirmation: false,
        pendingNavigation: null,

        // Toast
        toastVisible: false,
        toastTitle: '',
        toastMessage: '',

        // Dialogs
        invalidDialogOpen: false,
        numberListDialogOpen: false,
        packagePickerOpen: false,
        numberSelectionOpen: false,
        editingProvider: '',
        pickerProvider: '',
        tempSelectedPackage: '',
        tempEditingNumbers: [],
        tempEditingAssignments: [],
        hasUnsavedChanges: false,

        // Package Picker State
        packageSearch: '',
        selectedDurationFilter: 'all',
        durationFilters: [
          { value: 'all', label: 'Semua' },
          { value: '1-3', label: '1-3 hari' },
          { value: '4-7', label: '4-7 hari' },
          { value: '8-14', label: '8-14 hari' },
          { value: '15-21', label: '15-21 hari' },
          { value: '22-30', label: '22-30 hari' },
          { value: '30+', label: '> 30 hari' },
        ],
        pickerProviderDisplay: '', // Store original provider name for display

        // Number Selection State (Step 2)
        selectedPackageForNumbers: null,
        tempSelectedNumbers: [],
        numberSearch: '',
        singleEditNumber: null, // For single-number mode from Daftar Nomor dialog
        singleEditItemId: null, // For individual mode picker

        // Multi-package assignments: { provider: [{ packageId, numbers[] }] }
        providerPackages: {},

        // Validation
        validationError: false,

        // Computed
        get todayDate() {
          return new Date().toISOString().split('T')[0];
        },

        get validCount() {
          return this.parsedNumbers.filter(n => n.isValid && n.provider).length;
        },

        get invalidCount() {
          return this.parsedNumbers.filter(n => !n.isValid || !n.provider).length;
        },

        get itemCount() {
          if (this.mode === 'bulk') {
            return this.validCount;
          } else {
            return this.individualItems.filter(i => i.msisdn && i.packageId && i.provider).length;
          }
        },

        get subtotal() {
          if (this.mode === 'bulk') {
            let total = 0;
            Object.entries(this.providerPackages).forEach(([provider, assignments]) => {
              assignments.forEach(assignment => {
                const pkg = this.packages.find(p => p.id === assignment.packageId);
                if (pkg) {
                  total += pkg.price * assignment.numbers.length;
                }
              });
            });
            return total;
          } else {
            let total = 0;
            this.individualItems.forEach(item => {
              if (item.msisdn && item.packageId && item.provider) {
                const pkg = this.packages.find(p => p.id === item.packageId);
                if (pkg) total += pkg.price;
              }
            });
            return total;
          }
        },

        get profit() {
          if (this.mode === 'bulk') {
            let profit = 0;
            Object.entries(this.providerPackages).forEach(([provider, assignments]) => {
              assignments.forEach(assignment => {
                const pkg = this.packages.find(p => p.id === assignment.packageId);
                if (pkg) {
                  profit += (pkg.sellPrice - pkg.price) * assignment.numbers.length;
                }
              });
            });
            return profit;
          } else {
            let profit = 0;
            this.individualItems.forEach(item => {
              if (item.msisdn && item.packageId && item.provider) {
                const pkg = this.packages.find(p => p.id === item.packageId);
                if (pkg) profit += (pkg.sellPrice - pkg.price);
              }
            });
            return profit;
          }
        },

        get totalWithFee() {
          return this.subtotal + this.platformFee;
        },

        // Get detailed order items
        getOrderItems() {
          const items = [];

          if (this.mode === 'bulk') {
            // Collect from bulk mode
            Object.entries(this.providerPackages).forEach(([provider, assignments]) => {
              assignments.forEach(assignment => {
                const pkg = this.packages.find(p => p.id === assignment.packageId);
                if (pkg) {
                  assignment.numbers.forEach(msisdn => {
                    items.push({
                      msisdn,
                      provider,
                      packageId: pkg.id,
                      packageName: pkg.name,
                      price: pkg.price,
                      sellPrice: pkg.sellPrice,
                      profit: pkg.sellPrice - pkg.price,
                    });
                  });
                }
              });
            });
          } else {
            // Collect from individual mode
            this.individualItems.forEach(item => {
              if (item.msisdn && item.packageId && item.provider) {
                const pkg = this.packages.find(p => p.id === item.packageId);
                if (pkg) {
                  items.push({
                    msisdn: normalizeMsisdn(item.msisdn),
                    provider: item.provider,
                    packageId: pkg.id,
                    packageName: pkg.name,
                    price: pkg.price,
                    sellPrice: pkg.sellPrice,
                    profit: pkg.sellPrice - pkg.price,
                  });
                }
              }
            });
          }

          return items;
        },

        // Lifecycle
        async init() {
          const savedUser = getUser();
          if (savedUser && savedUser.name) {
            this.user = { ...savedUser, initials: this.getInitials(savedUser.name) };
          }
          if (!isLoggedIn()) {
            window.location.href = 'login.html';
          }

          // Render shared header component
          renderHeader('order');

          await this.loadPackages();
          
          // Intercept all navigation attempts
          const checkUnsavedData = () => {
            return this.mode === 'bulk' 
              ? (this.parsedNumbers.length > 0 || this.bulkInput.trim().length > 0)
              : (this.individualItems.some(item => item.msisdn.trim().length > 0));
          };

          // Intercept link clicks
          document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link && link.href && !link.target && checkUnsavedData()) {
              e.preventDefault();
              this.pendingNavigation = link.href;
              this.showLeaveConfirmation = true;
            }
          });

          // Intercept browser back/forward/refresh
          window.addEventListener('beforeunload', (e) => {
            if (checkUnsavedData()) {
              e.preventDefault();
              e.returnValue = '';
            }
          });
        },

        cancelLeave() {
          this.showLeaveConfirmation = false;
          this.pendingNavigation = null;
        },

        confirmLeave() {
          this.showLeaveConfirmation = false;
          if (this.pendingNavigation) {
            window.location.href = this.pendingNavigation;
          }
        },

        async loadPackages(retryCount = 0) {
          try {
            this.packagesLoading = true;
            const response = await fetch('https://kuotaumroh.id/api/belidigi/package?ref_code=bulkumroh');

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (!Array.isArray(data) || data.length === 0) {
              throw new Error('No packages returned from API');
            }

            this.packages = data.map(pkg => ({
              id: pkg.id,
              type: pkg.type,
              name: pkg.name,
              price: parseInt(pkg.price),
              sellPrice: parseInt(pkg.price_digipos),
              days: pkg.days
            }));

            this.showToast('Berhasil', `${this.packages.length} paket dimuat`);

          } catch (err) {
            console.error('Failed to load packages:', err);

            // Retry up to 2 times
            if (retryCount < 2) {
              this.showToast('Mencoba ulang...', `Percobaan ${retryCount + 2}/3`);
              setTimeout(() => this.loadPackages(retryCount + 1), 2000);
            } else {
              this.showToast('Error', 'Gagal memuat paket setelah 3 percobaan. Silakan refresh halaman.');
            }
          } finally {
            this.packagesLoading = false;
          }
        },

        // Methods
        getInitials(name) {
          return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        },

        parseBulkNumbers() {
          if (!this.bulkInput.trim()) {
            this.parsedNumbers = [];
            this.providerGroups = {};
            return;
          }
          
          const lines = this.bulkInput.split(/[\n,;]+/).map(l => l.trim()).filter(Boolean);
          this.parsedNumbers = lines.map(line => {
            const normalized = normalizeMsisdn(line);
            const isValid = validateMsisdn(normalized);
            const provider = isValid ? detectProvider(normalized) : null;
            return { msisdn: normalized, provider, isValid };
          });

          // Group by provider
          const groups = {};
          this.parsedNumbers.filter(n => n.isValid && n.provider).forEach(num => {
            if (!groups[num.provider]) groups[num.provider] = [];
            groups[num.provider].push(num.msisdn);
          });
          this.providerGroups = groups;
        },

        handleFileUpload(event) {
          const file = event.target.files?.[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            const content = e.target.result;
            this.bulkInput = this.bulkInput ? this.bulkInput + '\n' + content : content;
            this.parseBulkNumbers();
          };
          reader.readAsText(file);
          event.target.value = '';
        },

        getPackagesForProvider(provider) {
          if (!provider) return [];
          const normalizedProvider = this.normalizeProviderForApi(provider);
          return this.packages.filter(p => p.type === normalizedProvider);
        },

        normalizeProviderForApi(provider) {
          const map = {
            'TELKOMSEL': 'SIMPATI',
            'SIMPATI': 'SIMPATI',
            'AS': 'SIMPATI',
            'XL': 'XL',
            'AXIS': 'XL',
            'INDOSAT': 'INDOSAT',
            'IM3': 'INDOSAT',
            'MENTARI': 'INDOSAT',
            // Don't normalize TRI, SMARTFREN, or other providers
            // Let them query their own package types from the API
          };
          return map[provider?.toUpperCase()] || provider;
        },

        // Package Picker methods
        openPackagePicker(provider) {
          console.log('openPackagePicker called with provider:', provider);
          this.pickerProvider = provider;
          this.pickerProviderDisplay = provider; // Store original name for display
          this.tempSelectedPackage = '';
          this.packageSearch = '';
          this.selectedDurationFilter = 'all';
          this.singleEditNumber = null; // Reset single-number mode
          this.singleEditItemId = null;
          this.numberSelectionOpen = false;
          this.numberListDialogOpen = false;
          this.packagePickerOpen = true;
          console.log('packagePickerOpen set to:', this.packagePickerOpen);
        },

        // Single number package picker (from Daftar Nomor dialog)
        openSingleNumberPackagePicker(provider, msisdn) {
          this.pickerProvider = provider;
          this.pickerProviderDisplay = provider; // Store original name for display
          this.tempSelectedPackage = '';
          this.packageSearch = '';
          this.selectedDurationFilter = 'all';
          this.singleEditNumber = msisdn; // Set single-number mode
          this.singleEditItemId = null;
          this.numberSelectionOpen = false;
          this.packagePickerOpen = true;
        },

        // Individual mode package picker (single-number, no step 2)
        openIndividualPackagePicker(item) {
          if (!item?.provider) return;
          this.pickerProvider = item.provider;
          this.pickerProviderDisplay = item.provider;
          this.tempSelectedPackage = '';
          this.packageSearch = '';
          this.selectedDurationFilter = 'all';
          this.singleEditNumber = null;
          this.singleEditItemId = item.id;
          this.numberSelectionOpen = false;
          this.numberListDialogOpen = false;
          this.packagePickerOpen = true;
        },

        getPickerNumbers() {
          return this.providerGroups[this.pickerProvider] || [];
        },

        // Get filtered packages based on search and duration filter
        getFilteredPackages() {
          let pkgs = this.getPackagesForProvider(this.pickerProvider);
          
          // Apply search filter
          if (this.packageSearch.trim()) {
            const search = this.packageSearch.toLowerCase();
            pkgs = pkgs.filter(p => p.name.toLowerCase().includes(search));
          }
          
          // Apply duration filter
          if (this.selectedDurationFilter !== 'all') {
            pkgs = pkgs.filter(p => {
              const days = parseInt(p.days) || 0;
              switch (this.selectedDurationFilter) {
                case '1-3': return days >= 1 && days <= 3;
                case '4-7': return days >= 4 && days <= 7;
                case '8-14': return days >= 8 && days <= 14;
                case '15-21': return days >= 15 && days <= 21;
                case '22-30': return days >= 22 && days <= 30;
                case '30+': return days > 30;
                default: return true;
              }
            });
          }
          
          return pkgs;
        },

        // Step 1 -> Step 2: Select package and open number selection (or apply directly for single-number mode)
        selectPackageAndOpenNumberSelection(pkg) {
          // Single-number mode: apply directly without step 2
          if (this.singleEditNumber) {
            this.updateNumberPackage(this.pickerProvider, this.singleEditNumber, pkg.id);
            this.showToast('Paket Dipilih', `${pkg.name} berhasil diterapkan`);
            this.packagePickerOpen = false;
            this.singleEditNumber = null;
            return;
          }
          if (this.singleEditItemId) {
            const target = this.individualItems.find(item => item.id === this.singleEditItemId);
            if (target) {
              target.packageId = pkg.id;
              this.showToast('Paket Dipilih', `${pkg.name} berhasil diterapkan`);
            }
            this.packagePickerOpen = false;
            this.singleEditItemId = null;
            return;
          }
          
          // Multi-number mode: open step 2
          this.selectedPackageForNumbers = pkg;
          this.tempSelectedNumbers = [...this.getPickerNumbers()]; // Pre-select all numbers
          this.numberSearch = '';
          this.numberSelectionOpen = true;
        },

        closeNumberSelection() {
          this.numberSelectionOpen = false;
          this.selectedPackageForNumbers = null;
          this.tempSelectedNumbers = [];
        },

        // Number selection helpers
        areAllNumbersSelected() {
          const numbers = this.getPickerNumbers();
          return numbers.length > 0 && numbers.every(n => this.tempSelectedNumbers.includes(n));
        },

        toggleSelectAllNumbers() {
          const numbers = this.getPickerNumbers();
          if (this.areAllNumbersSelected()) {
            this.tempSelectedNumbers = [];
          } else {
            this.tempSelectedNumbers = [...numbers];
          }
        },

        toggleNumberSelection(num) {
          const idx = this.tempSelectedNumbers.indexOf(num);
          if (idx === -1) {
            this.tempSelectedNumbers.push(num);
          } else {
            this.tempSelectedNumbers.splice(idx, 1);
          }
        },

        getFilteredPickerNumbers() {
          let numbers = this.getPickerNumbers();
          if (this.numberSearch.trim()) {
            numbers = numbers.filter(n => n.includes(this.numberSearch));
          }
          return numbers;
        },

        getNumberCurrentPackage(msisdn) {
          const assignments = this.providerPackages[this.pickerProvider] || [];
          for (const a of assignments) {
            if (a.numbers.includes(msisdn)) {
              return this.getPackageName(a.packageId);
            }
          }
          return null;
        },

        // Apply number selection (Step 2 -> Done)
        applyNumberSelection() {
          if (!this.selectedPackageForNumbers || this.tempSelectedNumbers.length === 0) return;
          
          const packageId = this.selectedPackageForNumbers.id;
          const provider = this.pickerProvider;
          
          if (!this.providerPackages[provider]) {
            this.providerPackages[provider] = [];
          }
          
          // Remove selected numbers from other assignments
          this.providerPackages[provider] = this.providerPackages[provider].map(a => ({
            ...a,
            numbers: a.numbers.filter(n => !this.tempSelectedNumbers.includes(n))
          })).filter(a => a.numbers.length > 0);
          
          // Add or update assignment for this package
          const existing = this.providerPackages[provider].find(a => a.packageId === packageId);
          if (existing) {
            existing.numbers = [...existing.numbers, ...this.tempSelectedNumbers];
          } else {
            this.providerPackages[provider].push({
              packageId: packageId,
              numbers: [...this.tempSelectedNumbers]
            });
          }
          
          this.providerPackages = { ...this.providerPackages }; // Trigger reactivity
          this.validationError = false;
          
          this.showToast('Paket Dipilih', `${this.tempSelectedNumbers.length} nomor akan menggunakan ${this.selectedPackageForNumbers.name}`);
          this.closeNumberSelection();
          this.packagePickerOpen = false;
        },

        // Number List Dialog helpers
        getNumberPackageId(provider, msisdn) {
          const assignments = this.providerPackages[provider] || [];
          for (const a of assignments) {
            if (a.numbers.includes(msisdn)) {
              return a.packageId;
            }
          }
          return '';
        },

        updateNumberPackage(provider, msisdn, packageId) {
          if (!this.providerPackages[provider]) {
            this.providerPackages[provider] = [];
          }
          
          // Remove from current assignment
          this.providerPackages[provider] = this.providerPackages[provider].map(a => ({
            ...a,
            numbers: a.numbers.filter(n => n !== msisdn)
          })).filter(a => a.numbers.length > 0);
          
          // Add to new assignment if packageId is provided
          if (packageId) {
            const existing = this.providerPackages[provider].find(a => a.packageId === packageId);
            if (existing) {
              existing.numbers.push(msisdn);
            } else {
              this.providerPackages[provider].push({
                packageId: packageId,
                numbers: [msisdn]
              });
            }
          }
          
          this.providerPackages = { ...this.providerPackages }; // Trigger reactivity
        },

        // Keep old method for backwards compatibility
        selectPackageForAllNumbers(packageId) {
          const numbers = this.providerGroups[this.pickerProvider] || [];
          if (!this.providerPackages[this.pickerProvider]) {
            this.providerPackages[this.pickerProvider] = [];
          }
          this.providerPackages[this.pickerProvider] = [{
            packageId: packageId,
            numbers: [...numbers]
          }];
          this.providerPackages = { ...this.providerPackages };
          this.validationError = false;
          this.packagePickerOpen = false;
          this.showToast('Paket Dipilih', `${numbers.length} nomor akan menggunakan paket ini`);
        },

        // Assignment helpers
        getProviderAssignments(provider) {
          return this.providerPackages[provider] || [];
        },

        getPackageName(packageId) {
          const pkg = this.packages.find(p => p.id === packageId);
          return pkg ? pkg.name : 'Unknown';
        },

        getUnassignedNumbers(provider) {
          const allNumbers = this.providerGroups[provider] || [];
          const assignedNumbers = (this.providerPackages[provider] || []).flatMap(a => a.numbers);
          return allNumbers.filter(n => !assignedNumbers.includes(n));
        },

        getProviderSubtotal(provider) {
          const assignments = this.providerPackages[provider] || [];
          let total = 0;
          assignments.forEach(a => {
            const pkg = this.packages.find(p => p.id === a.packageId);
            if (pkg) total += pkg.price * a.numbers.length;
          });
          return total;
        },

        getProviderSellTotal(provider) {
          const assignments = this.providerPackages[provider] || [];
          let total = 0;
          assignments.forEach(a => {
            const pkg = this.packages.find(p => p.id === a.packageId);
            if (pkg) total += pkg.sellPrice * a.numbers.length;
          });
          return total;
        },

        getProviderProfit(provider) {
          return this.getProviderSellTotal(provider) - this.getProviderSubtotal(provider);
        },

        detectProviderForItem(item) {
          if (!item.msisdn) return null;
          const normalized = normalizeMsisdn(item.msisdn);
          if (!validateMsisdn(normalized)) return null;
          return detectProvider(normalized);
        },

        addIndividualItem() {
          this.individualItems.push({ id: Date.now().toString(), msisdn: '', packageId: '', provider: null });
        },

        removeIndividualItem(id) {
          if (this.individualItems.length > 1) {
            this.individualItems = this.individualItems.filter(i => i.id !== id);
          }
        },

        handleConfirmOrder() {
          if (this.itemCount === 0 || this.subtotal === 0) {
            this.showToast('Validasi Gagal', 'Silakan lengkapi pesanan Anda');
            return;
          }

          // Check for unpaired numbers in bulk mode
          if (this.mode === 'bulk') {
            const providersWithUnpaired = Object.keys(this.providerGroups).filter(p => this.getUnassignedNumbers(p).length > 0);
            if (providersWithUnpaired.length > 0) {
              this.validationError = true;
              this.showToast('Validasi Gagal', `Ada ${providersWithUnpaired.length} provider dengan nomor yang belum dipilih paketnya`);
              return;
            }
          }

          // Check for unpaired in individual mode
          if (this.mode === 'individual') {
            const unpaired = this.individualItems.filter(i => i.msisdn && i.provider && !i.packageId);
            if (unpaired.length > 0) {
              this.validationError = true;
              this.showToast('Validasi Gagal', 'Ada nomor yang belum dipilih paketnya');
              return;
            }
          }

          this.validationError = false;

          this.isProcessing = true;
          this.showToast('Pesanan Dikonfirmasi', 'Anda akan dialihkan ke halaman pembayaran...');

          setTimeout(async () => {
            // Get detailed order items
            const orderItems = this.getOrderItems();

            // Generate batch ID and name
            const timestamp = Date.now();
            const batchId = `BATCH-${timestamp}`;
            const batchName = `Order ${new Date().toLocaleDateString('id-ID')} ${new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}`;
            
            // Format schedule date
            let scheduleDate = null;
            if (this.activationTime === 'scheduled' && this.scheduledDate) {
              const date = new Date(this.scheduledDate);
              if (this.scheduledTime) {
                const [hours, minutes] = this.scheduledTime.split(':');
                date.setHours(parseInt(hours), parseInt(minutes), 0, 0);
              }
              scheduleDate = date.toISOString();
            }

            // Create backend-ready array format
            const backendPayload = orderItems.map(item => ({
              batch_id: batchId,
              batch_name: batchName,
              msisdn: item.msisdn,
              provider: item.provider,
              package_id: item.packageId,
              schedule_date: scheduleDate
            }));

            // Log the array for backend integration
            console.log('=== BACKEND PAYLOAD ===');
            console.log(JSON.stringify(backendPayload, null, 2));
            console.log('======================');

            // TODO: Submit order to backend API
            // Uncomment this when backend is ready:
            try {
              const response = await submitOrderBatch(backendPayload);
              console.log('âœ… Order submitted to backend:', response);
              
              // If submission fails, show error
              if (!response.success) {
                this.showToast('Error', 'Gagal mengirim pesanan ke backend');
                this.isProcessing = false;
                return;
              }
            } catch (error) {
              console.error('âŒ Failed to submit order:', error);
              this.showToast('Error', 'Gagal mengirim pesanan: ' + error.message);
              this.isProcessing = false;
              return;
            }

            // Store enhanced order data for payment page
            localStorage.setItem('pendingOrder', JSON.stringify({
              // Order summary
              itemCount: this.itemCount,
              subtotal: this.subtotal,
              platformFee: this.platformFee,
              profit: this.profit,
              total: this.totalWithFee,

              // Backend payload (ready to send)
              backendPayload: backendPayload,

              // Batch info
              batchId: batchId,
              batchName: batchName,

              // Items detail (for display)
              items: orderItems.map(item => ({
                msisdn: item.msisdn,
                provider: item.provider,
                packageId: item.packageId,
                packageName: item.packageName,
                price: item.price,
                sellPrice: item.sellPrice,
                profit: item.profit,
              })),

              // Payment & scheduling
              paymentMethod: this.paymentMethod,
              activationTime: this.activationTime,
              scheduledDate: scheduleDate,
              scheduledTime: this.scheduledTime,

              // Metadata
              createdAt: new Date().toISOString(),
              mode: this.mode, // 'bulk' or 'individual'
            }));
            window.location.href = 'payment.html';
          }, 1500);
        },

        saveBatchName() {
          if (this.tempBatchName.trim()) {
            this.batchName = this.tempBatchName.trim();
            this.showToast('Berhasil', 'Nama batch telah diperbarui');
            this.editBatchNameDialog = false;
          }
        },

        showToast(title, message) {
          this.toastTitle = title;
          this.toastMessage = message;
          this.toastVisible = true;
          setTimeout(() => { this.toastVisible = false; }, 3000);
        },

        // Dialog methods
        get invalidNumbers() {
          return this.parsedNumbers.filter(n => !n.isValid || !n.provider);
        },

        deleteInvalidNumber(msisdn) {
          this.bulkInput = this.bulkInput.split(/[\n,;]+/)
            .map(l => l.trim())
            .filter(l => normalizeMsisdn(l) !== msisdn)
            .join('\n');
          this.parseBulkNumbers();
        },

        deleteAllInvalidNumbers() {
          const invalidMsisdns = this.invalidNumbers.map(n => n.msisdn);
          this.bulkInput = this.bulkInput.split(/[\n,;]+/)
            .map(l => l.trim())
            .filter(l => !invalidMsisdns.includes(normalizeMsisdn(l)))
            .join('\n');
          this.parseBulkNumbers();
          this.invalidDialogOpen = false;
          this.showToast('Berhasil', `${invalidMsisdns.length} nomor tidak valid dihapus`);
        },

        openNumberListDialog(provider) {
          this.editingProvider = provider;
          // Deep copy current state for temporary editing
          this.tempEditingNumbers = [...(this.providerGroups[provider] || [])];
          const assignments = this.providerPackages[provider] || [];
          this.tempEditingAssignments = JSON.parse(JSON.stringify(assignments));
          this.hasUnsavedChanges = false;
          this.packagePickerOpen = false;
          this.numberSelectionOpen = false;
          this.numberListDialogOpen = true;
        },

        getEditingNumbers() {
          if (this.numberListDialogOpen) {
            return this.tempEditingNumbers;
          }
          return this.providerGroups[this.editingProvider] || [];
        },

        deleteNumberFromProvider(provider, msisdn) {
          if (this.numberListDialogOpen) {
            this.tempEditingNumbers = this.tempEditingNumbers.filter(n => n !== msisdn);
            // Also remove from assignments if present
             this.tempEditingAssignments = this.tempEditingAssignments.map(a => ({
              ...a,
              numbers: a.numbers.filter(n => n !== msisdn)
            })).filter(a => a.numbers.length > 0);
            this.hasUnsavedChanges = true;
            return;
          }

          // Direct delete (fallback)
          this.bulkInput = this.bulkInput.split(/[\n,;]+/)
            .map(l => l.trim())
            .filter(l => normalizeMsisdn(l) !== msisdn)
            .join('\n');
          this.parseBulkNumbers();
        },

        deleteProviderNumbers(provider) {
          const nums = this.providerGroups[provider] || [];
          this.bulkInput = this.bulkInput.split(/[\n,;]+/)
            .map(l => l.trim())
            .filter(l => !nums.includes(normalizeMsisdn(l)))
            .join('\n');
          delete this.providerPackages[provider];
          this.parseBulkNumbers();
          this.showToast('Berhasil', `${nums.length} nomor ${provider} dihapus`);
        },

        saveListChanges() {
          // Commit tempEditingNumbers to bulkInput
          // We need to remove numbers that are no longer in tempEditingNumbers
          // But keep numbers from other providers
          
          const currentProviderNumbers = this.providerGroups[this.editingProvider] || [];
          // Numbers to be kept for this provider = tempEditingNumbers
          // Numbers that were deleted = currentProviderNumbers - tempEditingNumbers
          
          const deletedNumbers = currentProviderNumbers.filter(n => !this.tempEditingNumbers.includes(n));
          
          if (deletedNumbers.length > 0) {
              // Rebuild bulkInput excluding deleted numbers
              this.bulkInput = this.bulkInput.split(/[\n,;]+/)
                .map(l => l.trim())
                .filter(l => {
                    const normalized = normalizeMsisdn(l);
                    return !deletedNumbers.includes(normalized);
                })
                .join('\n');
              this.parseBulkNumbers();
          }
          
          // Commit assignments
          this.providerPackages[this.editingProvider] = JSON.parse(JSON.stringify(this.tempEditingAssignments));
          // Trigger reactivity
          this.providerPackages = { ...this.providerPackages };
          
          this.hasUnsavedChanges = false;
          this.showToast('Berhasil', 'Perubahan disimpan');
        },

        getTempEditingSubtotal() {
          let total = 0;
          this.tempEditingAssignments.forEach(a => {
            const pkg = this.packages.find(p => p.id === a.packageId);
            if (pkg) total += pkg.price * a.numbers.length;
          });
          return total;
        },

        // Helper for single edit mode applying to temp state
        updateTempNumberPackage(provider, msisdn, packageId) {
             // Remove from current temp assignment
            this.tempEditingAssignments = this.tempEditingAssignments.map(a => ({
                ...a,
                numbers: a.numbers.filter(n => n !== msisdn)
            })).filter(a => a.numbers.length > 0);
            
            // Add to new assignment if packageId is provided
            if (packageId) {
                const existing = this.tempEditingAssignments.find(a => a.packageId === packageId);
                if (existing) {
                    existing.numbers.push(msisdn);
                } else {
                    this.tempEditingAssignments.push({
                        packageId: packageId,
                        numbers: [msisdn]
                    });
                }
            }
            this.hasUnsavedChanges = true;
        },

        // Number List Dialog helpers
        getNumberPackageId(provider, msisdn) {
          const assignments = this.numberListDialogOpen ? this.tempEditingAssignments : (this.providerPackages[provider] || []);
          for (const a of assignments) {
            if (a.numbers.includes(msisdn)) {
              return a.packageId;
            }
          }
          return '';
        },

        updateNumberPackage(provider, msisdn, packageId) {
          if (this.numberListDialogOpen) {
              this.updateTempNumberPackage(provider, msisdn, packageId);
              return;
          }

          if (!this.providerPackages[provider]) {
            this.providerPackages[provider] = [];
          }
          
          // Remove from current assignment
          this.providerPackages[provider] = this.providerPackages[provider].map(a => ({
            ...a,
            numbers: a.numbers.filter(n => n !== msisdn)
          })).filter(a => a.numbers.length > 0);
          
          // Add to new assignment if packageId is provided
          if (packageId) {
            const existing = this.providerPackages[provider].find(a => a.packageId === packageId);
            if (existing) {
              existing.numbers.push(msisdn);
            } else {
              this.providerPackages[provider].push({
                packageId: packageId,
                numbers: [msisdn]
              });
            }
          }
          
          this.providerPackages = { ...this.providerPackages }; // Trigger reactivity
        },

        logout() {
          clearUser();
          window.location.href = 'login.html';
        }
      }
    }
  </script>

  <!-- Shared Scripts -->
  <script src="shared/utils.js"></script>
  <script src="shared/api.js"></script>
  <script src="shared/components.js"></script>
</body>
</html>
